@model IEnumerable<YES_og.Models.cnc000>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";

    List<YES_og.Models.sts000> sts = ViewBag.sts;
    List<YES_og.Models.zip000> zip000 = ViewBag.zip000;
}

<div class="row">
    <div class="col-lg-12">
        <div class="ibox ">
            <div class="ibox-title">
                <h5>案件追蹤管理</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    @*<a class="dropdown-toggle" data-toggle="dropdown" href="table_data_tables.html#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user">
                            <li>
                                <a href="table_data_tables.html#" class="dropdown-item">Config option 1</a>
                            </li>
                            <li>
                                <a href="table_data_tables.html#" class="dropdown-item">Config option 2</a>
                            </li>
                        </ul>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>*@
                </div>
            </div>
            <div class="ibox-content">
                <a class="btn btn-primary mb-3" href="/Follow/Create">
                    新增資料
                </a>
                @*<button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#sendEmailModal">
                        發送
                    </button>*@
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="cncTable">
                        <thead>
                            <tr>
                                <th>案件編號</th>
                                <th>會員姓名</th>
                                <th>手機號碼</th>
                                <th>車輛品牌</th>
                                <th>住宅類型</th>
                                <th>所在縣市</th>
                                <th>目前進度</th>
                                <th>申請時間</th>
                                <th>功能</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in Model)
                            {
                                <tr>
                                    <td>
                                        @{
                                            string cncId = int.Parse(i.cnc_id.ToString()).ToString("000000");
                                            @cncId
                                        }

                                    </td>
                                    <td>@i.contact_person</td>
                                    <td>@i.contact_mobile</td>
                                    <td>@i.veh_brand</td>
                                    <td>
                                        @sts.FirstOrDefault(x => x.item_id == i.loc_class && x.prog_id == "cnc000" && x.fun_id == "loc_class").item_desc
                                    </td>
                                    <td>
                                        @i.zip_id
                                        @*@{
                                                string z = zip000.FirstOrDefault(x => x.zip_id == i.zip_id).country+'-'+ zip000.FirstOrDefault(x => x.zip_id == i.zip_id).district;
                                                @z
                                            }*@
                                    </td>
                                    <td>@sts.FirstOrDefault(x => x.item_id == i.cnc_status && x.prog_id == "cnc000" && x.fun_id == "cnc_status").item_desc</td>
                                    <td>@String.Format("{0:yyyy/MM/dd}", i.crt_date)</td>
                                    <td>
                                        <button class="btn btn-primary mb-3" onclick="location.href='@Url.Action("Edit", "Follow", new { id = i.cnc_id})'">
                                            編輯
                                        </button>
                                        @*<button type="button" class="btn btn-primary mb-3" name="sendBtn" data-toggle="modal" data-target="#sendEmailModal">
                                                發送
                                            </button>*@
                                        <button type="button" class="btn btn-warning mb-3" name="sendBtn" btn-id="@i.cnc_id">
                                            發送
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Modal -->
@using (Html.BeginForm(null, null, FormMethod.Post, new { enctype = "multipart/form-data", id = "EmailDataForm" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)
    <div class="modal inmodal fade" id="sendEmailModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">E-mail發送</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="tabs-container">
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li><a class="nav-link active" data-toggle="tab" href="#tab-1">已立案</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#tab-2">場勘時間</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#tab-3">報價單</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#tab-4">施工時間</a></li>
                                    </ul>
                                    <div class="tab-content">
                                        <div role="tabpanel" id="tab-1" class="tab-pane active">
                                            <div class="panel-body" id="tab-1body">
                                                @*<textarea class="form-control">

                                                    </textarea>*@
                                            </div>
                                        </div>
                                        <div role="tabpanel" id="tab-2" class="tab-pane">
                                            <div class="panel-body" id="tab-2body">
                                            </div>
                                        </div>
                                        <div role="tabpanel" id="tab-3" class="tab-pane">
                                            <div class="panel-body" id="tab-3body">
                                            </div>
                                        </div>
                                        <div role="tabpanel" id="tab-4" class="tab-pane">
                                            <div class="panel-body" id="tab-4body">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group row mt-3">
                                    <label class="col-sm-2 col-form-label">插入附件</label>
                                    <div class="col-sm-10">
                                        <div id="tUploadArea">
                                            <input type="file" multiple max-size="10485760" accept-extension="docx|doc|pptx|ppt|jpg|jpeg|png|pdf|zip|rar|7z|xlsx" />
                                            <span style="word-break: break-all;" class="d-block small noticeTxt">(僅接受 DOCX,DOC,PPTX,PPT,JPG,JPEG,PNG,PDF,ZIP,RAR,7Z,xlsx)</span>
                                            <div id='tUploadFileList' class="filename"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="sendBtn">發送</button>
                </div>
            </div>
        </div>
    </div>
}


    @section Scripts {
        <script>
        $(document).ready(function () {
            $('#cncTable').DataTable({
                pageLength: 25,
                responsive: true,
                dom: '<"html5buttons"B>lTfgitp',
                order: [[7, 'desc']],
                buttons: [
                ]
            });
        });

        //檔案上傳
        var tUpload = [];
        $.MultiUploadFile("tUploadArea", "tUploadFileList", tUpload);

        //get發送detail
        $('#cncTable').on('click','button[name="sendBtn"]',
            function () {
                var btnData = $(this).attr('btn-id');

                $.ajax({
                    type: "POST",
                    async: true,
                    url: "/Follow/sendMailDetail",
                    data: {
                        id: btnData
                    },
                    dataType: "json",
                    success: function (data) {
                        $('#sendEmailModal').modal('show');
                        $('#tab-1body').html("");
                        $('#tab-2body').html("");
                        $('#tab-3body').html("");
                        $('#tab-4body').html("");
                        $('#tab-1body').append(Tab1Data(data));
                        $('#tab-2body').append(Tab2Data(data));
                        $('#tab-3body').append(Tab3Data(data));
                        $('#tab-4body').append(Tab4Data(data));

                    }
                });
            });

        function Tab1Data(data) {
            var sb = new StringBuffer();
            sb.append(' <input type="hidden" name="cncId" id="cncId" value="' + data.cncId + '">');
            sb.append(' <input type="hidden" name="recipientMail" id="recipientMail" value="' + data.contact_email + '">');
            sb.append('<textarea class="form-control" style="height:250px;">');
            sb.append('親愛的車主  ' + data.contact_person + ' 先生/小姐  您好：&#10;');
            sb.append('案件編號：' + data.cncId + '&#10;');
            sb.append('您的電動車充電樁建置進度，目前已完成立案 ，我們會隨時更新進度，並再以E-Mail方式即時告知您。&#10;');
            sb.append('若有任何疑問，請聯繫業務代表OOO，手機號碼 0000000000。&#10;');
            sb.append('很榮幸能為您服務，祝您一切平安順利。&#10;');
            sb.append('裕電俥電股份有限公司  敬上。&#10;');
            sb.append('</textarea>');

            var html = sb.toString();
            return html;
        }

        function Tab2Data(data) {
            var sb = new StringBuffer();
            sb.append(' <input type="hidden" name="cncId" id="cncId" value="' + data.cncId + '">');
            sb.append(' <input type="hidden" name="recipientMail" id="recipientMail" value="' + data.contact_email + '">');
            sb.append('<textarea class="form-control" style="height:250px;">');
            sb.append('親愛的車主  ' + data.contact_person + ' 先生/小姐  您好：&#10;');
            sb.append('案件編號：' + data.cncId + '&#10;');
            sb.append('您的電動車充電樁建置場勘時間已確認在 ' + data.survey_time + '。&#10;');
            sb.append('我們抵達前會再次與您聯繫。&#10;');
            sb.append('若有任何疑問，請聯繫業務代表OOO，手機號碼 0000000000。&#10;');
            sb.append('很榮幸能為您服務，祝您一切平安順利。&#10;');
            sb.append('裕電俥電股份有限公司  敬上。&#10;');
            sb.append('</textarea>');

            var html = sb.toString();
            return html;
        }

        function Tab3Data(data) {
            var sb = new StringBuffer();
            sb.append(' <input type="hidden" name="cncId" id="cncId" value="' + data.cncId + '">');
            sb.append(' <input type="hidden" name="recipientMail" id="recipientMail" value="' + data.contact_email + '">');
            sb.append('<textarea class="form-control" style="height:250px;">');
            sb.append('親愛的車主  ' + data.contact_person + ' 先生/小姐  您好：&#10;');
            sb.append('案件編號：' + data.cncId + '&#10;');
            sb.append('您的電動車充電樁安裝場勘報價已完成，請參考附件報價單詳細資訊。&#10;');
            sb.append('若您對報價單沒有問題，再煩請您簽名，並用傳真/E-Mail回寄/拍照等方式將報價單回傳給我們。&#10;');
            sb.append('若有任何疑問，請聯繫業務代表OOO，手機號碼 0000000000。&#10;');
            sb.append('很榮幸能為您服務，祝您一切平安順利。&#10;');
            sb.append('裕電俥電股份有限公司  敬上。&#10;');
            sb.append('</textarea>');

            var html = sb.toString();
            return html;
        }

        function Tab4Data(data) {
            var sb = new StringBuffer();
            sb.append(' <input type="hidden" name="cncId" id="cncId" value="' + data.cncId + '">');
            sb.append(' <input type="hidden" name="recipientMail" id="recipientMail" value="' + data.contact_email + '">');
            sb.append('<textarea class="form-control" style="height:250px;">');
            sb.append('親愛的車主  ' + data.contact_person + ' 先生/小姐  您好：&#10;');
            sb.append('案件編號：' + data.cncId + '&#10;');
            sb.append('您的電動車充電樁施工時間已確認在 ' + data.install_time + '。&#10;');
            sb.append('我們抵達前會再次與您聯繫。&#10;');
            sb.append('若有任何疑問，請聯繫業務代表OOO，手機號碼 0000000000。&#10;');
            sb.append('很榮幸能為您服務，祝您一切平安順利。&#10;');
            sb.append('裕電俥電股份有限公司  敬上。&#10;');
            sb.append('</textarea>');

            var html = sb.toString();
            return html;
        }

        $('#sendBtn').click(function () {
            var msg = "您確定要發送嗎?";
            if (confirm(msg) == true) {
                dataFormAjaxPost($('#EmailDataForm'), "/Follow/SendEmail");
            } else {
                return false;
            }
        });

            function dataFormAjaxPost($dataForm, url) {
                debugger;
                var cnc_id = $('#cncId').val();
                var recipientMail = $('#recipientMail').val();

                var formData = new FormData($dataForm[0]);

                var subject = $('.nav-link.active').text();
                var getId = $('.nav-link.active').attr('href').replace('#','');

                const element = document.getElementById(getId);
                var content = $(element).text();

                formData.append('cnc_id', cnc_id);
                formData.append('recipientMail', recipientMail);
                formData.append('subject', subject);
                formData.append('content', content);

                //多檔上傳的檔案夾帶
                for (var i = 0; i < tUpload.length; i++) {
                    formData.append('tUpload', tUpload[i]);
                }

                $.ajax({
                    url: url,
                    data: formData,
                    type: 'post',
                    contentType: false,
                    processData: false,
                    cache: false,
                    //async: false,
                    datatype: 'JSON',
                    success: function (data) {
                        debugger;
                        if (data.IsSuccess == true) {
                            swal({
                                title: 'SUCCESS',
                                text: '發送成功',
                                icon: 'success'
                            }, function () {
                                $('#sendEmailModal').modal('hide');
                            });
                        } else {
                            swal({
                                title: 'Fail',
                                text: data.ErrorMessage,
                                icon: 'error'
                            });
                        }
                    }
                });


            }

            

        </script>
    }

